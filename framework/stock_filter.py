# -*- coding: utf-8 -*-

import logging
import time
import pandas as pd
from concurrent.futures import ThreadPoolExecutor, as_completed
from datetime import date
from typing import List, Dict, Any, Optional, Tuple
import os

from .data_fetch_manager import DataFetcherManager
from utils.config import FilterArgs
from utils.logger import Logger

logger = Logger(__name__)

BASE_DAILY_AMOUNT = 200000000
BASE_MARKET_VALUE = 5000000000
BASE_INCOME_INCREASE = 0.1

MA20_AMOUNT = 300000000
MA20_AMOUNT_FACTOR = 1.3
EMA200_SLOP = -0.05
GLODEN_CROSS_DAYS = 1
CROSS_COUNT_10D = 1
MACD_HISTOGRAM = 0

EMA200_DEVIATION_RATE_HIGH = 25
EMA200_DEVIATION_RATE_LOW = 15
INCOME_INCREASE_20D = 25
INCOME_INCREASE_60D = 50
ATR_RATE = 4.0
BOLL_PCT_B = 0.9

RISK_SCORE_THRESHOLD = 1

class StockFilter:
    
    def __init__(
        self,
        args: Optional[FilterArgs] = None,
        max_workers: Optional[int] = None,
    ):
        if args is None:
            args = FilterArgs()
        self.args = args
        self.max_workers = max_workers or self.args.max_workers
        # 初始化各模块
        self.fetcher_manager = DataFetcherManager(args.fetcher_args)
        logger.info(f"调度器初始化完成，最大并发数: {self.max_workers}")

    def filter_stocks(self) -> List[str]:
        # stock_codes = self.base_info_filter()
        stock_codes = ['300812', '300719', '300251', '688147', '688702', '688409', '300486', '688280', '920808', '002498', '600984', '000839', '601777', '601890', '002843', '600629', '000859', '002703', '000021', '600410', '001896', '600893', '603960', '002009', '605289', '603533', '603163', '002169', '002951', '603466', '605007', '002510', '300369', '688629', '688031', '688586', '600397', '300589', '688563', '300100', '603090', '002988', '301193', '000738', '688767', '688510', '688533', '605255', '920119', '300065', '000833', '603103', '301363', '688579', '300567', '603297', '301285', '301217', '002655', '688292', '300107', '300766', '300779', '001330', '600641', '688001', '688419', '300258', '600977', '000973', '002467', '300718', '688343', '688085', '301518', '301013', '000016', '603667', '300042', '301018', '002812', '688785', '688239', '300806', '688308', '688652', '300887', '688319', '002931', '002196', '301292', '301286', '300587', '688809', '002297', '002896', '300749', '688561', '002519', '300552', '688627', '688515', '300938', '300895', '603929', '688549', '688337', '603000', '603197', '301293', '001203', '688433', '001309', '688172', '688141', '688027', '603306', '300461', '300528', '002163', '301308', '688548', '302132', '300846', '001331', '301611', '300079', '300131', '301326', '301488', '000559', '300648', '002134', '300739', '603738', '300473', '300260', '600730', '601595', '600391', '002283', '688017', '002837', '300830', '600673', '300788', '301595', '301269', '300008', '002870', '600966', '600960', '688261', '603124', '002912', '688535', '301259', '688630', '603186', '002709', '301160', '688135', '002654', '688386', '688249', '000688', '600862', '603800', '002766', '688023', '600110', '603138', '688353', '301357', '301316', '688521', '002008', '301628', '688818', '688603', '600869', '300581', '688072', '600372', '688066', '688556', '000006', '300440', '688037', '603078', '688107', '002739', '688322', '603156', '002371', '300579', '603683', '688626', '002268', '603155', '688361', '002405', '300302', '300368', '603638', '600376', '002235', '688392', '300655', '300499', '300300', '603650', '003018', '002307', '301002', '301235', '000599', '300469', '600015', '603088', '688625', '000796', '002177', '688552', '688519', '002407', '600292', '688279', '002831', '002261', '605056', '300475', '300017', '688297', '603986', '688252', '688347', '002246', '300516', '603626', '601599', '300352', '600184', '300551', '001267', '603341', '002173', '003021', '300607', '002756', '300006', '002741', '300219', '688585', '002920', '688583', '300099', '300497', '002050', '688691', '301626', '600733', '600985', '002387', '600756', '600760', '605318', '300790', '300660', '000672', '300421', '603596', '688120', '000858', '000681', '688775', '301358', '600685', '600562', '300672', '000592', '688661', '002320', '000066', '300810', '688469', '301348', '003009', '600126', '600703', '300189', '301012', '600667', '688372', '600619', '601965', '003029', '600580', '688605', '603950', '300201', '002265', '603876', '002979', '300397', '300024', '300604', '605599', '603728', '000768', '002975', '301202', '600764', '300037', '688432', '300457', '600038', '000002', '002797', '300249', '601606', '600971', '688484', '300768', '300192', '600592', '600436', '603588', '000670', '300731', '603026', '300227', '300342', '688033', '300852', '002042', '301629', '002885', '300972', '688660', '002083', '000977', '300123', '300184', '600158', '600208', '688262', '600138', '600203', '600150', '301248', '002240', '300429', '688097', '688099', '002384', '000766', '001287', '300151', '688256', '002475', '000922', '603002', '300802', '002389', '603888', '002527', '002906', '002414', '000572', '601096', '688326', '600515', '300308', '603859', '000981', '000596', '601212', '300842', '601001', '300696', '002985', '600415', '300304', '300687', '600775', '002185', '002378', '600313', '300680', '000568', '002436', '600143', '002067', '300666', '300629', '300747', '601888', '688543', '002735', '002213', '603936', '600509', '002472', '300661', '002600', '920640', '000628', '301127', '688449', '603662', '300007', '688039', '300503', '600933', '301025', '002036', '000519', '300129', '002284', '600113', '002779', '300049', '300115', '603360', '688233', '300568', '002212', '002023', '300520', '688049', '300735', '002463', '601127', '002602', '688981', '300805', '688200', '300296', '002439', '002031', '300447', '300328', '002714', '601858', '002402', '002164', '000823', '688816', '000415', '600967', '603690', '301297', '603119', '688403', '688270', '600635', '600872', '000423', '600072', '300814', '000712', '002520', '301120', '603160', '002707', '301256', '301338', '001212', '688160', '002549', '300576', '300502', '301421', '300139', '688321', '300416', '300991', '002747', '600895', '300390', '000776', '002413', '002446', '601456', '002548', '002017', '300221', '601916', '601169', '301638', '600011', '002204', '300310', '000564', '688300', '688408', '688591', '688116', '603496', '300903', '000818', '600765', '300857', '000158', '601133', '300468', '600660', '600519', '002466', '600699', '600258', '600216', '002643', '002208', '688728', '600737', '601061', '688502', '301517', '688012', '000032', '300547', '688102', '300872', '000651', '002324', '300900', '601009', '300871', '300476', '688368', '300446', '601515', '002152', '300199', '601059', '002474', '300351', '000555', '301191', '688388', '002624', '002881', '301580', '600905', '600835', '301510', '000661', '600016', '301487', '600446', '002947', '600809', '688090', '000935', '002046', '000762', '601818', '601229', '300623', '002456', '600839', '300098', '603912', '600114', '002611', '603444', '688126', '002897', '688169', '002415', '601995', '600151', '300346', '601728', '688277', '600651', '600919', '600536', '300331', '688362', '300303', '002736', '300455', '000065', '000538', '000887', '002448', '688601', '600316', '002428', '301511', '603730', '601666', '300290', '002121', '300769', '000001', '603019', '600900', '600850', '600598', '002048', '000938', '601788', '301486', '301389', '603345', '688778', '601838', '600887', '002304', '002385', '601066', '600930', '603985', '601619', '600666', '688709', '002290', '301031', '000999', '000050', '605598', '002859', '600602', '002236', '601608', '601166', '300324', '002142', '002197', '603605', '002471', '300045', '601988', '300349', '300188', '603486', '600104', '002123', '300676', '002138', '601985', '001979', '688711', '688772', '000078', '301236', '600435', '600089', '600332', '601006', '600221', '688352', '000155', '002422', '002276', '002603', '688678', '002179', '688123', '600795', '688002', '300458', '300432', '600008', '000967', '002487', '688559', '688779', '002497', '601128', '002625', '600886', '601689', '300236', '000034', '000983', '600577', '002649', '600999', '002241', '600501', '002077', '300450', '600036', '603778', '000625', '002074', '600690', '601020', '002716', '600941', '300232', '300255', '002119', '002460', '601878', '603296', '002176', '603530', '600109', '300925', '301306', '688110', '301458', '002203', '002558', '600958', '603236', '601658', '300209', '300207', '600018', '000166', '002317', '601668', '688327', '688700', '600103', '002728', '300480', '002251', '300777', '600601', '600452', '002027', '605358', '601868', '688095', '603288', '600050', '300053', '688506', '300257', '300004', '002966', '600880', '603659', '601665', '300493', '002796', '301526', '600009', '300409', '600276', '603920', '603061', '600610', '603129', '002929', '002352', '601077', '002063', '300083', '601336', '600000', '301150', '600066', '688088', '300124', '300498', '603319', '600030', '300073', '000617', '600188', '601727', '301093', '300688', '601877', '600926', '601933', '002202', '002916', '000333', '002657', '603338', '601998', '688180', '688418', '002785', '300054', '688271', '001208', '601398', '300541', '688766', '601186', '601162', '300999', '002594', '002299', '000063', '300339', '603938', '002815', '601319', '300252', '300048', '301050', '301489', '002925', '300035', '300122', '600023', '002156', '601377', '002937', '600179', '000963', '601688', '600048', '603298', '000700', '000792', '600170', '300144', '001696', '600879', '600416', '600686', '002174', '601901', '603501', '600654', '300919', '300975', '002430', '601138', '300496', '601555', '002250', '002440', '002396', '002085', '300525', '600584', '300068', '688795', '300679', '688235', '002537', '605111', '300770', '300896', '300953', '002886', '603893', '603087', '600570', '300353', '300244', '601698', '301128', '600196', '300322', '601881', '688208', '000547', '605090', '002673', '300438', '688019', '600718', '600998', '300133', '605499', '000733', '600118', '601111', '300674', '002104', '002183', '600115', '600873', '300337', '603011', '688435', '002230', '600021', '000725', '600363', '601328', '600120', '600877', '300760', '000997', '603606', '601099', '001337', '002244', '603039', '002294', '000829', '689009', '601816', '002161', '600246', '000901', '600745', '002065', '603328', '002311', '002245', '600171', '600640', '300990', '600859', '601939', '600266', '688041', '600808', '688578', '300319', '002025', '601198', '688692', '600715', '002243', '002792', '600797', '300047', '301522', '600100', '300059', '600588', '300593', '300003', '301196', '002426', '002788', '003816', '603315', '002639', '002249', '605488', '300223', '688382', '002049', '002151', '600702', '300627', '301078', '002409', '601618', '603220', '002131', '000728', '002215', '002278', '000686', '300634', '600185', '002273', '600693', '000969', '601208', '600845', '688802', '002484', '300102', '600206', '300228', '300033', '300773', '300433', '300573', '600418', '002279', '300850', '002149', '600406', '600331', '600060', '601766', '688608', '000751', '000563', '002078', '300077', '600027', '002738', '300130', '000750', '002501', '000729', '600230', '601519', '002366', '600353', '300474', '600398', '688227', '601226', '603200', '688234', '002296', '688146', '300678', '001386', '601678', '300036', '600383', '002334', '300657', '600076', '000100', '601919', '601288', '300012', '000801', '601211', '603766', '300088', '600563', '002922', '603169', '002379', '300699', '002292', '002192', '002239', '688082', '688047', '300142', '002181', '000620', '002054', '300204', '600460', '300327', '300708', '601106', '000799', '688333', '002229', '600088', '688018', '688400', '601601', '002312', '002266', '601799', '300820', '002432', '601669', '603300', '603118', '601628', '688380', '688275', '688411', '601966', '601118', '300782', '300740', '000680', '002410', '605020', '601789', '600095', '600352', '601360', '600499', '600075', '600388', '603881', '301377', '300969', '603283', '600909', '688036', '601018', '688301', '603301', '600201', '688480', '603260', '300034', '002939', '300487', '600728', '600482', '002153', '300229', '300127', '603663', '603267', '002670', '688530', '600373', '600516', '600734', '300619', '301137', '300001', '002455', '600133', '301200', '002706', '300725', '000506', '603232', '600763', '688536', '601069', '002223', '600157', '002597', '688187', '000523', '300181', '688111', '002155', '300693', '688523', '600783', '688545', '600166', '603379', '002984', '301172', '300638', '601918', '300427', '605277', '002264', '300435', '688596', '000970', '603083', '601318', '688303', '688385', '000987', '600268', '000676', '002354', '688063', '002157', '301005', '300483', '601808', '300377', '688416', '301566', '603286', '600704', '002416', '603179', '603228', '002092', '600061', '301291', '688266', '603005', '601012', '688183', '688127', '300217', '300762', '000623', '600779', '301165', '601778', '603678', '688005', '601717', '002948', '600621', '603185', '000612', '300957', '603305', '688568', '300014', '300299', '601112', '002171', '605589', '300085', '000783', '000875', '301382', '600596', '601677', '300866', '603773', '688052', '300066', '600029', '600637', '688150', '601222', '002300', '688800', '300224', '300827', '603686', '603290', '600395', '002488', '002237', '688008', '002309', '003031', '600959', '688332', '300153', '600801', '002056', '300164', '000560', '002170', '002745', '603125', '601137', '002607', '688035', '688668', '603516', '600186', '002075', '601108', '002560', '600343', '605117', '600256', '601696', '600744', '300212', '601015', '000917', '301536', '601016', '000778', '002605', '300043', '002256', '000825', '000993', '000988', '600438', '600010', '300373', '002044', '002851', '688593', '300378', '600585', '600226', '601388', '000682', '002531', '603599', '603256', '600776', '002465', '601179', '300185', '601390', '300505', '601611', '000156', '000582', '002895', '300533', '601155', '300179', '300364', '601929', '688028', '600916', '000630', '300765', '688122', '600426', '601898', '600770', '300413', '002459', '600546', '002518', '600740', '300913', '300843', '600183', '688209', '600096', '002444', '601880', '000420', '600497', '688787', '002544', '601100', '002079', '301413', '601992', '301029', '002182', '300684', '000629', '600131', '300628', '002195', '000723', '603171', '600988', '600868', '600963', '002361', '600578', '002582', '600160', '300145', '300027', '300602', '600814', '002145', '600761', '603456', '002562', '300738', '002850', '002526', '301262', '001389', '000683', '002150', '301551', '300471', '601117', '688777', '300558', '601058', '300136', '601699', '600141', '601005', '601225', '600348', '603887', '600338', '600633', '601088', '301251', '002636', '300015', '000157', '603009', '000962', '002945', '688222', '300767', '300071', '002028', '688387', '002545', '300759', '688331', '000923', '300855', '300226', '300459', '002001', '000525', '002539', '000528', '002115', '002617', '603063', '002645', '300401', '688365', '300775', '000878', '300803', '688059', '603861', '600362', '000581', '600163', '000400', '002821', '000422', '002536', '688698', '688228', '600172', '300750', '300444', '301408', '600477', '600019', '603108', '000966', '601567', '600058', '300726', '300811', '600649', '002734', '605196', '600312', '603259', '300603', '600885', '600361', '603077', '600531', '000060', '002254', '300821', '300215', '002441', '601116', '688498', '688615', '605366', '002130', '002667', '601958', '600475', '300250', '000408', '300002', '300398', '600346', '688525', '300253', '300748', '002315', '000543', '300781', '600366', '002167', '002648', '003041', '688375', '002201', '300986', '600219', '301123', '601216', '300196', '000425', '688807', '301086', '600522', '300763', '000690', '000510', '600759', '002335', '601865', '601969', '603507', '002064', '600552', '300191', '603396', '300618', '920368', '000893', '301230', '000039', '301252', '600282', '300758', '688318', '600063', '601126', '600938', '603698', '603123', '603757', '002270', '300291', '000975', '603867', '688210', '000758', '688676', '600547', '605060', '600871', '600732', '600863', '002281', '300005', '603162', '000301', '300316', '002606', '000807', '601866', '601609', '601121', '300315', '688257', '688213', '000591', '301500', '300494', '002358', '000685', '300010', '688717', '002683', '688456', '000603', '601233', '300870', '600309', '002555', '002364', '000703', '600888', '002165', '600028', '002158', '688508', '605018', '002339', '600456', '600031', '601908', '300861', '603799', '002340', '300724', '300170', '002128', '603308', '603612', '600968', '002493', '600459', '603806', '300682', '600489', '603619', '002938', '301071', '603052', '688220', '002470', '600995', '002258', '600399', '600022', '000880', '603979', '301026', '000737', '300408', '601231', '600618', '600517', '601615', '688599', '002970', '301141', '000811', '600428', '000933', '300436', '000791', '600710', '600490', '300776', '002601', '600550', '300067', '002565', '000786', '002546', '000830', '688396', '600486', '301095', '001280', '601600', '002759', '603381', '300285', '688390', '000417', '600884', '301162', '002222', '601991', '300393', '603132', '600339', '600498', '600782', '600989', '000709', '600556', '002373', '601399', '002126', '301529', '002129', '603601', '603127', '000426', '600987', '301362', '002080', '603737', '603629', '300418', '300383', '002318', '601083', '002534', '603115', '301219', '600259', '600841', '002291', '300706', '300624', '002015', '000822', '002595', '002810', '000831', '002532', '301317', '000932', '002517', '600751', '300671', '601168', '301550', '002271', '600961', '300265', '300395', '600301', '300063', '002865', '688167', '300113', '603031', '002533', '688622', '601857', '600711', '300118', '300263', '000338', '002400', '301205', '002225', '605123', '600111', '301312', '301171', '600392', '600105', '300274', '600207', '300658', '600821', '600590', '300456', '600589', '000951', '002943', '000949', '301183', '300347', '603150', '688312', '600595', '603225', '688472', '600722', '688516', '601899', '003035', '300490', '002218', '001359', '300757', '603993', '605376', '301232', '300835', '600583', '301396', '600409', '000657', '603191', '300454', '000960', '600875', '300792', '603097', '600549', '688190', '002353', '603067', '301468', '603699', '920438', '000815', '688726', '688223', '002842', '300394', '000636', '300140', '000534', '000600', '920493', '300277', '300058', '603598', '600828', '601636', '688313', '688158', '603688', '300785', '600986', '601869', '300943', '002112', '920045', '300166', '300819', '002043', '300617', '300101', '000533', '603216', '002438', '001376', '002429', '600176', '688503', '002272', '000767', '600586', '300921', '603212', '300570', '688258', '002757', '688143', '301636', '600345', '605006', '688048', '002623', '600330', '601872', '688205', '600487', '002478', '601975', '300751', '688195', '688025', '301085', '600026', '002506', '002824', '600370', '002099', '002323', '000892', '603980', '002342', '600481', '300620', '603618', '000070', '002957', '002969', '002491', '605287', '600545', '300182', '300548']
        batch = 40
        step = int(os.environ.get('STEP', 0))
        start = batch * step
        end = min(batch * (step + 1), len(stock_codes))
        stock_codes = self.income_filter(stock_codes[start:end])
        logger.info(f"input stock_codes from {start} to {end}, return size: {len(stock_codes)}")
        logger.info(f"output stock_codes: {stock_codes}")
        #stock_codes = self.history_info_filter(stock_codes)
        return stock_codes

    def base_info_filter(self) -> List[str]:
        df_all = self.fetcher_manager.get_all_realtime_quote()
        df_filtered = df_all[~df_all['name'].str.contains("ST")]
        df_filtered = df_filtered[df_filtered['amount'] > BASE_DAILY_AMOUNT] # 单日成交额
        df_filtered = df_filtered[df_filtered['total_mv'] > BASE_MARKET_VALUE] # 总市值
        stock_list = df_filtered['code'].tolist()
        return stock_list

    def income_filter(self, stock_list:List[str]) -> List[str]:
        print(stock_list)
        all_income_data = []
        with ThreadPoolExecutor(max_workers=self.args.max_workers) as executor:
            # 提交任务
            future_to_code = {
                executor.submit(
                    self.fetcher_manager.get_income_data,
                    code
                ): code
                for code in stock_list
            }
            
            # 收集结果
            for idx, future in enumerate(as_completed(future_to_code)):
                code = future_to_code[future]
                try:
                    result = future.result()
                    if result:
                        all_income_data.append(result)

                    # Issue #128: 分析间隔 - 在个股分析和大盘分析之间添加延迟
                    if idx < len(stock_list) - 1 and self.args.analysis_delay > 0:
                        logger.debug(f"等待 {self.args.analysis_delay} 秒后继续下一只股票...")
                        time.sleep(self.args.analysis_delay)

                except Exception as e:
                    logger.error(f"[{code}] 任务执行失败: {e}")

        df_filtered = pd.DataFrame(all_income_data)
        print(df_filtered)
        df_filtered = df_filtered[df_filtered['income_inc'] >= BASE_INCOME_INCREASE]
        return df_filtered['code'].tolist()

    def history_info_filter(self, stock_list:List[str]) -> List[str]:
        logger.info(f"开始处理{len(stock_list)}只股票: {stock_list}")
        filted_stocks = []
        with ThreadPoolExecutor(max_workers=self.args.max_workers) as executor:
            # 提交任务
            future_to_code = {
                executor.submit(
                    self._history_info_filter,
                    code
                ): code
                for code in stock_list
            }
            
            # 收集结果
            for idx, future in enumerate(as_completed(future_to_code)):
                code = future_to_code[future]
                try:
                    result = future.result()
                    if result:
                        filted_stocks.append(code)

                    # Issue #128: 分析间隔 - 在个股分析和大盘分析之间添加延迟
                    if idx < len(stock_list) - 1 and self.args.analysis_delay > 0:
                        logger.debug(f"等待 {self.args.analysis_delay} 秒后继续下一只股票...")
                        time.sleep(self.args.analysis_delay)

                except Exception as e:
                    logger.error(f"[{code}] 任务执行失败: {e}")
        logger.info(f"处理完成，剩余{len(filted_stocks)}只股票: {filted_stocks}")
        return filted_stocks

    def _history_info_filter(self, stock_code: str):
        stock_data = self.fetcher_manager.get_daily_analyzed_data(stock_code)
        if stock_data is None:
            return False
        trend_result = self._single_trend_filter(stock_data)
        risk_result = self._single_risk_filter(stock_data)
        additional_result = self._single_additional_filter(stock_data)
        return trend_result and risk_result and additional_result

    def _single_trend_filter(self, stock_data):
        # 20日成交额 > 3亿 && 当日成交量 》= 1.3 x 20日均量
        if stock_data['amount_ma20'] < MA20_AMOUNT:
            return False
        if stock_data['amount'] < stock_data['amount_ma20'] * MA20_AMOUNT_FACTOR:
            return False
        # ema200 > 收盘
        if stock_data['ema200'] < stock_data['close']:
            return False
        # ema200斜率 < -0.05
        if stock_data['ema200_slop'] < EMA200_SLOP:
            return False
        # EMA5上穿EMA10≥1日 && 10日内EMA5/10交叉≤1次
        if stock_data['gloden_cross_days'] < GLODEN_CROSS_DAYS:
            return False
        if stock_data['cross_count_10d'] > CROSS_COUNT_10D:
            return False
        # macd histogram > 0
        if stock_data['macd_histogram'] < MACD_HISTOGRAM:
            return False
        return True
    
    def _single_risk_filter(self, stock_data):
        risk_score = 0
        # 长期偏离EMA200
        if abs(stock_data['ema200_deviation_rate']) > EMA200_DEVIATION_RATE_HIGH:
            return False
        elif abs(stock_data['ema200_deviation_rate']) > EMA200_DEVIATION_RATE_LOW:
            risk_score += 1
        # 20日涨幅是否超过25%，60日涨幅是否超过50%
        if stock_data['20d_inc'] > INCOME_INCREASE_20D:
            risk_score += 1
        if stock_data['60d_inc'] > INCOME_INCREASE_60D:
            risk_score += 1
        # ATR/收盘价比值是否>4%
        if stock_data['atr_rate'] > ATR_RATE:
            risk_score += 1
        # 布林带%B是否连续2日>0.9
        if stock_data['bb_percent_b1'] is not None and stock_data['bb_percent_b1'] > BOLL_PCT_B and \
            stock_data['bb_percent_b1'] is not None and stock_data['bb_percent_b2'] > BOLL_PCT_B:
            risk_score += 1
        return risk_score <= RISK_SCORE_THRESHOLD

    def _single_additional_filter(self, stock_data):
        # 可选 ema50 > ema200
        if stock_data['ema50'] < stock_data['ema200']:
           return False
        return True
