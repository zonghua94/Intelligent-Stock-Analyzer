name: daily-analyze

on:
  # 定时触发 - 每天北京时间 18:00 (UTC 10:00)
  schedule:
    - cron: '0 10 * * 1-5'     # 周一到周五，UTC 10:00 = 北京时间 18:00
  
  # 手动触发
  workflow_dispatch:
    inputs:
      step:
        description: 'step'
        required: true
        default: '0'
        type: string

# 并发控制：同一时间只运行一个分析任务
concurrency:
  group: stock-analysis
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    # 添加超时限制，防止任务卡死
    timeout-minutes: 600
    
    steps:
      - name: 随机延迟（避免固定时间访问）
        run: sleep $((RANDOM % 60))  # 随机延迟0-60秒启动
      
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: 开始执行
        env:
          SERVERCHAN3_SENDKEY: ${{ secrets.SERVERCHAN3_SENDKEY }}
          STEP: ${{ github.event.inputs.step }}
        run: |
           python test.py