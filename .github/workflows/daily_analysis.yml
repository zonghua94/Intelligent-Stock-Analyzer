name: 每日股票分析

on:
  # 定时触发 - 每天北京时间 18:00 (UTC 10:00)
  schedule:
    - cron: '0 10 * * 1-5'     # 周一到周五，UTC 10:00 = 北京时间 18:00
  
  # 手动触发
  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式'
        required: true
        default: 'full'
        type: choice
        options:
          - full          # 完整分析（股票+大盘）
          - market-only   # 仅大盘复盘
          - stocks-only   # 仅股票分析

# 并发控制：同一时间只运行一个分析任务
concurrency:
  group: stock-analysis
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    # 添加超时限制，防止任务卡死
    timeout-minutes: 30
    
    steps:
      - name: 随机延迟（避免固定时间访问）
        run: sleep $((RANDOM % 60))  # 随机延迟0-60秒启动
      
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: 开始执行
        run: |
          python test.py